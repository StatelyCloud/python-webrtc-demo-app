# StatelyDB Python WebRTC Demo App

This repository contains a demonstration of how StatelyDB can be used to implement a fully functional WebRTC video chat application using less than 1000 lines of code.

In this demo, we utilize StatelyDB List, Sync and Transaction functionality to periodically fetch updates to the virtual room
and propagate them to all connected participants.

## Contents
- [client](./client/): A simple HTML web page that can be opened in the browser and used to make a call
- [server](./server/): The Python signaling server implementation
- [server/schema](./server/schema): The StatelyDB Schema definition and generated code

## Data Model

We only need to define one Stately Item Type for this application!

We can model each Participant as a member of a virtual room using the `room` field which is templated into the Key Path: `/Room-:room/`. Fetching the full state of the room is then as simple as `await client.begin_list(key_path_prefix=key_path("/Room-{room}", room=<my-room>))`.
```typescript
export const Participant = itemType("Participant", {
  keyPath: ["/Room-:room/Participant-:username"],
  fields: {
    username: {
      // The self-assigned username of the participant.
      type: string,
      fieldNum: 1,
    },
    room: {
      // The room the participant is in. This is a simple string identifier.
      type: string,
      fieldNum: 2,
    },
    joined: {
      // The server generated timestamp of when the participant joined the room.
      // We use this to determine which peer is the "polite" peer during ICE negotiation.
      type: timestampMicroseconds,
      fieldNum: 3,
      fromMetadata: "createdAtTime",
    },
    session_id: {
      // This is a UUID that is generated by the server when a websocket connection is received
      // Session ID allows us to deduplicate multiple websockets from the same user which can
      // be left hanging after an unexpected disconnect.
      type: uuid,
      fieldNum: 4,
    },
    pending_sdp: {
      // This is an array of SDP strings that are waiting to be sent to the participant.
      // This queue is periodically checked by the server and streamed to the participant
      // over the websocket.
      // This queue contains JSON strings which must be parsed by the client.
      type: arrayOf(string),
      fieldNum: 5,
      required: false,
    },
  },
});
```

## Running this example

### Prerequisites
- Install [uv](https://docs.astral.sh/uv/getting-started/installation/) using your preferred installation method
- Onboard to Stately by following our [Getting Started](https://docs.stately.cloud/guides/getting-started/) guide. Once you have a store ID, client ID and client secret, You can create a server/.env file from our template in [server/.env.example](server/.env.example)

### Server
- Once you've met the prerequisites you can start the server with `$ uv run --directory server server.py`

### Client
- Once the server is running, You can open [client/client.html](./client/client.html) in two separate browser tabs and make a call between them.
- Make sure you input the same room and a different username for each user


